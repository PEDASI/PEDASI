{% extends "base.html" %}
{% load bootstrap4 %}

{% block content %}
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item" aria-current="page">
                <a href="{% url 'index' %}">Home</a>
            </li>
            <li class="breadcrumb-item" aria-current="page">
                <a href="{% url 'datasources:datasource.list' %}">Data Sources</a>
            </li>
            <li class="breadcrumb-item active" aria-current="page">
                {{ datasource.name }}
            </li>
        </ol>
    </nav>

    <div class="row">
        <div class="col-md-10 col-sm-8">
            <h2>{{ datasource.name }}</h2>

            {% if datasource.description %}
                {{ datasource.description|linebreaks }}
            {% endif %}
        </div>

        <div class="col-md-2 col-sm-4">
            <a href="{% url 'datasources:datasource.explorer' pk=datasource.id %}"
               class="btn btn-block btn-info" role="button">API Explorer</a>

            {% if request.user != datasource.owner and not request.user.is_superuser %}
                <a href="{% url 'datasources:datasource.access.request' pk=datasource.id %}"
                   class="btn btn-block btn-secondary" role="button">Manage My Access</a>
            {% endif %}

            {% if has_edit_permission %}
                <a href="{% url 'datasources:datasource.access.manage' pk=datasource.pk %}"
                   class="btn btn-block btn-primary" role="button">Manage Access</a>

                <a href="{% url 'admin:datasources_datasource_change' datasource.id %}"
                   class="btn btn-block btn-success" role="button">Edit</a>

                <a href="{% url 'admin:datasources_datasource_delete' datasource.id %}"
                   class="btn btn-block btn-danger" role="button">Delete</a>
            {% endif %}
        </div>
    </div>

    {% if datasource.is_encrypted %}
        <div class="alert alert-warning mt-3">
            <p>
                This data source contains encrypted data.
            </p>

            {% if datasource.encrypted_docs_url %}
                For guidance on how to process this data please see <a href="{{ datasource.encrypted_docs_url }}">{{ datasource.encrypted_docs_url }}</a>.
            {% endif %}
        </div>
    {% endif %}

    <table class="table">
        <thead>
            <th scope="col" class="w-25 border-0"></th>
            <th scope="col" class="border-0"></th>
        </thead>

        <tbody>
            <tr>
                <td>Owner</td>
                <td>
                    {{ datasource.owner }}
                </td>
            </tr>
            <tr>
                <td>URL</td>
                <td>{{ datasource.url }}</td>
            </tr>
        </tbody>
    </table>

    <div class="card">
        <div class="card-header" data-toggle="collapse" data-target="#collapseMetadata">
            <h6>Metadata</h6>
        </div>

        <div id="collapseMetadata" class="card-body collapse show">
            <table id="tableMetadata" class="table">
                <thead>
                <th scope="col" class="w-25 border-0"></th>
                <th scope="col" class="border-0"></th>
                <th scope="col" class="w-25 border-0"></th>
                </thead>

                <tbody>
                {% for metadata_item in datasource.metadata_items.all %}
                    <tr id="metadata-row-{{ metadata_item.field.short_name }}-{{ metadata_item.value }}">
                        <td>{{ metadata_item.field.name }}</td>
                        <td>{{ metadata_item.value }}</td>
                        <td>
                            <button role="button"
                                    onclick="deleteMetadata('{{ metadata_item.field.short_name }}','{{ metadata_item.value }}')"
                                    class="btn btn-sm btn-danger float-right">Delete</button>
                        </td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>

            {% if metadata_field_form %}
                <script type="application/javascript">
                    function getCookie(name) {
                        const re = new RegExp("(^| )" + name + "=([^;]+)");
                        const match = document.cookie.match(re);
                        if (match) return match[2];
                    }

                    function tableAppendRow(table, values, id=null) {
                        const row = table.insertRow(-1);
                        if (id !== null) {
                            row.id = id;
                        }

                        for (const value of values) {
                            const cell = row.insertCell(-1);
                            const text = document.createTextNode(value);
                            cell.appendChild(text);
                        }

                        return row;
                    }

                    function postMetadata() {
                        fetch(
                            "{% url 'datasources:datasource.metadata' pk=datasource.pk %}",
                            {
                                method: "POST",
                                body: JSON.stringify({
                                    field: document.getElementById("id_field").value,
                                    value: document.getElementById("id_value").value
                                }),
                                headers: {
                                    "Accept": "application/json",
                                    "Content-Type": "application/json",
                                    "X-CSRFToken": getCookie("csrftoken")
                                }
                            }
                        ).then(
                            response => response.json()
                        ).then(
                            function (response) {
                                if (response.status === "success") {
                                    const table = document.getElementById("tableMetadata");
                                    const field = response.data.field;
                                    const value = response.data.value;

                                    const row = tableAppendRow(
                                        table,
                                        [field, value],
                                        'metadata-row-' + response.data.field_short + '-' + value
                                    );

                                    const buttonCell = row.insertCell(-1);
                                    const button = document.createElement("button");

                                    button.id = "btn-" + field + "-" + value;
                                    button.classList.add("btn", "btn-sm", "btn-danger", "float-right");
                                    button.addEventListener(
                                        "click",
                                        function () {
                                            deleteMetadata(field, value);
                                        }
                                    );
                                    button.textContent = "Delete";
                                    buttonCell.appendChild(button);
                                    row.appendChild(buttonCell);
                                }
                            }
                        ).catch(
                            function (e) {
                                console.log(e);
                            }
                        )
                    }

                    function deleteMetadata(field, value) {
                        fetch(
                            "{% url 'datasources:datasource.metadata' pk=datasource.pk %}",
                            {
                                method: "DELETE",
                                body: JSON.stringify({
                                    field: field,
                                    value: value
                                }),
                                headers: {
                                    "Accept": "application/json",
                                    "Content-Type": "application/json",
                                    "X-CSRFToken": getCookie("csrftoken")
                                }
                            }
                        ).then(
                            response => response.json()
                        ).then(function (response) {
                            console.log(response);

                            if (response.status === "success") {
                                const row = document.getElementById("metadata-row-" + field + "-" + value);
                                row.parentNode.removeChild(row);
                            }

                        })
                    }
                </script>

                <form id="formMetadata" class="form" action="javascript:postMetadata();">
                    {% csrf_token %}

                    <div class="row">
                        <div class="col-3">
                            {% bootstrap_field metadata_field_form.field layout='inline' %}
                        </div>
                        <div class="col-6">
                            {% bootstrap_field metadata_field_form.value layout='inline' %}
                        </div>
                        <div class="col-3">
                            <button type="submit" class="btn btn-block btn-success">Add</button>
                        </div>
                    </div>
                </form>
            {% endif %}
        </div>
    </div>

    <hr>

    {% if is_catalogue %}
        <h2 class="mt-3">Data Sets</h2>

        <script type="application/javascript">
            function search() {
                // Give the user a visual cue that a search is happening
                $('#btn-search-rest').hide();
                $('#btn-search-active').show();

                const endpoint = "search?q=" + $("#id_query").val();

                // Load HTML response into element
                $('#dataset-results').load(endpoint, function(response, status, xhr) {
                    if (status === "error") {
                        const msg = "There was an error: ";
                        console.log(msg + xhr.status + " " + xhr.statusText);
                    }

                    // Reset the button
                    $('#btn-search-rest').show();
                    $('#btn-search-active').hide();
                });
            }

            function clearResults() {
                $('#dataset-results').empty();
            }
        </script>

        <form class="form-inline" action="javascript:search();">
            <div class="input-group">
                <input type="search" class="form-control" id="id_query"
                       aria-label="search" placeholder="Search">

                <div class="input-group-append">
                    <button type="submit" class="btn btn-outline-primary">
                        <i id="btn-search-rest" class="fas fa-search"></i>
                        <i id="btn-search-active" class="fas fa-spinner fa-pulse" style="display: none"></i>
                    </button>
                </div>

                <div class="input-group-append">
                    <button type="button" class="btn btn-outline-primary" onclick="clearResults();"><i class="fas fa-trash"></i></button>
                </div>
            </div>
        </form>

        <div id="dataset-results" class="row px-2">
        </div>
    {% endif %}

{% endblock %}